### EKF Configuration for Sensor Fusion
### Fuses wheel odometry (/odom) with IMU data (/imu/data) to correct for wheel slippage
### Outputs fused odometry on /odometry/filtered
### UPDATED: Uses full 9-DOF IMU with proper unit conversion (rad/s, m/s²)

ekf_filter_node:
  ros__parameters:
    # Frequency at which the filter publishes (Hz)
    # Set to 20Hz for responsive updates while not overloading Pi
    frequency: 20.0

    # The filter can operate in 2D (false) or 3D (true) mode
    # For differential drive on flat ground, 2D is appropriate
    two_d_mode: true

    # Transform publication settings
    publish_tf: true
    publish_acceleration: false

    # Predict to current time to reduce latency
    predict_to_current_time: true

    # Map frame name (for localization/SLAM integration)
    map_frame: map
    odom_frame: odom
    base_link_frame: base_link
    world_frame: odom # For odometry-only fusion (not SLAM localization)

    # ---------------------------------------------
    # Input Source 1: Wheel Odometry (/odom)
    # ---------------------------------------------
    odom0: /odom
    odom0_config: [
        true,
        true,
        false, # x, y, z position (USE as position reference - prevents unbounded drift)
        false,
        false,
        false, # roll, pitch, yaw orientation (DON'T use encoder yaw - slips during turns)
        true,
        true,
        false, # x_vel, y_vel, z_vel (USE wheel velocities - accurate for motion)
        false,
        false,
        false, # roll_vel, pitch_vel, yaw_vel (DISABLED - let IMU handle rotation)
        false,
        false,
        false, # x_accel, y_accel, z_accel
      ]
    odom0_queue_size: 2 # Reduced from 10 to minimize processing
    odom0_differential: false # Use absolute measurements
    odom0_relative: false

    # ---------------------------------------------
    # Input Source 2: IMU (/imu/data) - Full 9-DOF
    # ---------------------------------------------
    imu0: /imu/data
    # Enable full IMU: orientation (roll/pitch/yaw), angular_velocity (gyro), linear_acceleration
    imu0_config: [
        false,
        false,
        false, # x, y, z position (IMU doesn't provide position)
        true,
        true,
        true, # roll, pitch, yaw orientation (USE full DMP orientation for stable heading)
        false,
        false,
        false, # x_vel, y_vel, z_vel (not provided by IMU)
        true,
        true,
        true, # roll_vel, pitch_vel, yaw_vel (USE gyro XYZ - now properly scaled to rad/s)
        true,
        true,
        true, # x_accel, y_accel, z_accel (USE accelerometer - now properly scaled to m/s²)
      ]
    imu0_queue_size: 5 # Slightly larger to smooth bursts
    imu0_differential: false
    imu0_relative: false

    # Remove gravitational acceleration from IMU linear accel before fusion
    # This helps isolate actual robot motion from gravity
    imu0_remove_gravitational_acceleration: true

    # Measurement covariances - tune these to balance trust between sensors
    # INCREASED from defaults because MPU6050 has significant noise
    # If map still drifts, INCREASE these values further
    imu0_orientation_covariance: [0.1, 0.0, 0.0,
                                   0.0, 0.1, 0.0,
                                   0.0, 0.0, 0.05]  # Trust yaw (Z) more than roll/pitch
    
    imu0_angular_velocity_covariance: [0.02, 0.0, 0.0,
                                        0.0, 0.02, 0.0,
                                        0.0, 0.0, 0.02]  # Gyro is reasonably accurate
    
    imu0_linear_acceleration_covariance: [0.5, 0.0, 0.0,
                                           0.0, 0.5, 0.0,
                                           0.0, 0.0, 0.5]  # Accel is noisy - high covariance

    # ---------------------------------------------
    # Process Noise Covariance
    # ---------------------------------------------
    # How much we expect the state to change between measurements
    # Tune these if the filter is too "jumpy" (decrease) or too "sluggish" (increase)
    process_noise_covariance: [
        0.05,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0, # x
        0.0,
        0.05,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0, # y
        0.0,
        0.0,
        0.06,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0, # z
        0.0,
        0.0,
        0.0,
        0.03,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0, # roll
        0.0,
        0.0,
        0.0,
        0.0,
        0.03,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0, # pitch
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.06,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0, # yaw
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.025,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0, # x_vel
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.025,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0, # y_vel
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.04,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0, # z_vel
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.01,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0, # roll_vel
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.01,
        0.0,
        0.0,
        0.0,
        0.0, # pitch_vel
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.02,
        0.0,
        0.0,
        0.0, # yaw_vel
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.01,
        0.0,
        0.0, # x_accel
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.01,
        0.0, # y_accel
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.015, # z_accel
      ]

    # ---------------------------------------------
    # Initial State Covariance
    # ---------------------------------------------
    initial_estimate_covariance:
      [
        1e-9,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        1e-9,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        1e-9,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        1e-9,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        1e-9,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        1e-9,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        1e-9,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        1e-9,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        1e-9,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        1e-9,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        1e-9,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        1e-9,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        1e-9,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        1e-9,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        0.0,
        1e-9,
      ]
